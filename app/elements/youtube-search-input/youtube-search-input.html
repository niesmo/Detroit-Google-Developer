<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../elements/import-google-apis.html">

<dom-module id="youtube-search-input">
  <style>
    :host {
      display: block;
    }

    paper-input{
      --paper-input-container-color: rgba(255,255,255, 0.7);
      --paper-input-container-focus-color: rgba(255,255,255, 0.7);
      --paper-input-container-input-color: rgba(255,255,255, 0.7);

      --paper-input-suffix: {
        color:rgba(255,255,255, 0.7);
      };
    }

    paper-input[focused]{
      --paper-input-container-input-color: white;
    }

  </style>

  <template>

    <paper-input id="query" no-label value="{{searchQuery}}" disabled$="[[!youtubeIsReady]]">
      <iron-icon suffix icon="search"></iron-icon>
    </paper-input>
  </template>
</dom-module>
<script>
  (function(){
    'use strict';
    
    Polymer({
      is : "youtube-search-input",

      properties: {

        debounceLength: {
          type: Number,
          value: 300  
        },
        
        results: {
          type: Array,
          notify: true
        },
        
        searchQuery : {
          type: String,
          observer: "_searchQueryObserver"
        },

        youtubeIsReady: {
          type: Boolean,
          value: false,
          notify: true
        }
      },

      ready: function() {
        if(this._youtubeIsLoaded()){
          this._apiLoaded();
        }
        else{
          // import-google-apis.html fires an event when the youTube API is loaded
          this.listen(window, 'youtubeAPILoaded', '_apiLoaded');
        }
      },

      _apiLoaded: function(e){
        this.set('youtubeIsReady', true);
        this.$.query.value = "Google Polymer";
        this.unlisten(window, 'youtubeAPILoaded', '_apiLoaded');
      },

      _searchQueryObserver: function(query){
        if(!query) {
          this.set('results', []);
          this.cancelDebouncer("searchYoutubeDebouncer");
          return;
        }
        this.debounce("searchYoutubeDebouncer", this._searchYoutube, this.debounceLength);
      },

      _searchYoutube: function() {
        gapi.client.youtube.search.list({
          part: "snippet",
          q: this.searchQuery,
          type: "video",
          order: "relevance",
          maxResults: 10
        })
        .execute(function(response){
          this.set('results', this.searchQuery ? response.items : []);
        }.bind(this));
      },
      
      _youtubeIsLoaded: function(){
        return !!(gapi && gapi.client && gapi.client.youtube && gapi.client.youtube.search);
      }
    });
  })();
</script>